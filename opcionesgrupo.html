<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Grupo ¬∑ Opciones</title>
<style>
  :root{ --primary:#4A90E2; --dark:#1e2740; --card:#ffffff; --txt:#2b2f36 }
  *{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,Segoe UI,Roboto,sans-serif}
  body{background:#f5f6fb;color:var(--txt)}
  header{background:linear-gradient(135deg,var(--primary),#2E5FAA);color:#fff;padding:18px 0;text-align:center}
  .container{max-width:900px;margin:0 auto;padding:22px}
  .pill{display:inline-block;background:#ffffff22;border:1px solid #ffffff55;color:#fff;padding:6px 10px;border-radius:999px;font-size:13px}
  .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:16px;margin-top:14px}
  @media (max-width:900px){ .grid{grid-template-columns:1fr} }
  .card{background:var(--card);border-radius:14px;padding:22px;border:1px solid #e6ebf3;box-shadow:0 6px 18px rgba(0,0,0,.05)}
  .opt{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:26px;border:2px dashed #dbe3f1;border-radius:16px;gap:10px;transition:.2s}
  .opt:hover{border-color:var(--primary);transform:translateY(-2px)}
  .opt a{display:inline-flex;align-items:center;gap:8px;background:linear-gradient(135deg,var(--primary),#2E5FAA);color:#fff;text-decoration:none;padding:10px 16px;border-radius:10px;font-weight:600}
  .opt.disabled{opacity:.5;pointer-events:none}
  .opt .emoji{font-size:40px}
  .row{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;margin-bottom:12px}
  .btn{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border:1px solid #fff3;border-radius:10px;color:#fff;text-decoration:none}
  .btn-home{border-color:#2E5FAA;background:linear-gradient(135deg,#2E5FAA,#4A90E2)}
  .btn[aria-disabled="true"]{opacity:.6;pointer-events:none}
  .coming-soon{font-size:12px;color:#ff6b6b;font-weight:600;margin-top:5px;}
</style>
</head>
<body>
<header>
  <h1>Grupo ¬∑ Opciones</h1>
  <p id="ctx" class="pill"></p>
</header>

<div class="container">
  <div class="card">
    <div class="row">
      <div>Selecciona una opci√≥n</div>
      <a id="btnHome" class="btn btn-home" href="#">‚Üê Regresar</a>
    </div>

    <div class="grid">
      <!-- SUBIR LISTA (se deshabilita en modo code) -->
      <div class="opt" id="optSubir">
        <div class="emoji">üì§</div>
        <h3>Subir lista</h3>
        <p>Importa alumnos desde Excel/CSV.</p>
        <a id="linkSubir" href="#">Ir a Subir lista ‚Üí</a>
      </div>

      <!-- ASISTENCIA (siempre habilitado) -->
      <div class="opt" id="optAsis">
        <div class="emoji">üóìÔ∏è</div>
        <h3>Asistencia</h3>
        <p>Tomar asistencia del grupo.</p>
        <a id="linkAsis" href="#">Ir a Tomar Asistencia ‚Üí</a>
      </div>

      <!-- GR√ÅFICAS (se deshabilita en modo code) -->
      <div class="opt" id="optGraf">
        <div class="emoji">üìä</div>
        <h3>Gr√°ficos Asistencia</h3>
        <p>Ver estad√≠sticas del grupo.</p>
        <a id="linkGraf" href="#">Ver Gr√°ficos ‚Üí</a>
      </div>

      <!-- CALIFICACIONES (BLOQUEADA - no disponible a√∫n) -->
      <div class="opt disabled" id="optCalif">
        <div class="emoji">üìù</div>
        <h3>Calificaciones</h3>
        <p>Captura y consulta calificaciones.</p>
        <span class="coming-soon">Pr√≥ximamente</span>
        <!-- Enlace deshabilitado -->
        <a style="background: #ccc; cursor: not-allowed;">Ir a Calificaciones ‚Üí</a>
      </div>
    </div>
  </div>
</div>

<!-- Firebase solo para validar y resolver nombre de escuela -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore, doc, getDoc, collectionGroup
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBEIeZz3HeU-8EVirVx9JAYnGbBegh1Uh4",
    authDomain: "maestros-7faa6.firebaseapp.com",
    projectId: "maestros-7faa6",
    storageBucket: "maestros-7faa6.firebasestorage.app",
    messagingSenderId: "328284079222",
    appId: "1:328284079222:web:f0ab5c3443469d145d4b57",
    measurementId: "G-YKBQD9EJH3"
  };
  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  const p   = new URLSearchParams(location.search);
  const sid = p.get('sid');
  const gid = p.get('gid');
  const code = p.get('code'); // si viene, es acceso por c√≥digo

  const ctx = document.getElementById('ctx');
  const btnHome = document.getElementById('btnHome');

  const optSubir = document.getElementById('optSubir');
  const optGraf  = document.getElementById('optGraf');
  const optCalif = document.getElementById('optCalif');

  const linkSubir= document.getElementById('linkSubir');
  const linkAsis = document.getElementById('linkAsis');
  const linkGraf = document.getElementById('linkGraf');
  const linkCalif= document.getElementById('linkCalif');

  if(!sid || !gid){
    alert('Falta sid o gid en la URL');
    location.href = './escuelas.html';
  }

  const qp = (o)=>Object.entries(o)
    .filter(([,v])=>v!==undefined&&v!==null&&v!=='')
    .map(([k,v])=>`${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join('&');

  // Back
  btnHome.href = code
    ? `./grupos.html?${qp({ sid, code })}`
    : `./grupos.html?${qp({ sid })}`;

  // Propagar enlaces base
  linkSubir.href = `./subirlista.html?${qp({ sid, gid })}`;
  linkAsis.href  = `./tomarlista.html?${qp({ sid, gid })}`;
  linkGraf.href  = `./graficos.html?${qp({ sid, gid })}`;
  // Calificaciones deshabilitada - enlace eliminado
  if (linkCalif) linkCalif.remove();

  // ---- Mostrar solo el NOMBRE de la escuela ----
  let maestroId = null;

  async function resolveMaestroBySchoolId(schoolId){
    const cg = await getDocs(collectionGroup(db, 'escuelas')); // busca en todas las escuelas
    const found = cg.docs.find(d => d.id === schoolId);
    return found ? (found.ref.parent.parent?.id || null) : null; // maestros/{m}
  }

  async function loadSchoolNameOnly(){
    try{
      maestroId = await resolveMaestroBySchoolId(sid);
      if(!maestroId){
        ctx.textContent = 'Escuela';
        return;
      }
      const sSnap = await getDoc(doc(db,'maestros', maestroId, 'escuelas', sid));
      const schoolName = sSnap.exists() ? (sSnap.data().name || 'Escuela') : 'Escuela';
      ctx.textContent = code ? `${schoolName} ¬∑ Acceso por c√≥digo` : schoolName;
    }catch(e){
      console.error(e);
      ctx.textContent = 'Escuela';
    }
  }

  // En modo code, deshabilitar lo no permitido y validar
  async function enforceCodeMode(){
    if(!code) return;

    // Deshabilitar m√≥dulos no permitidos en acceso por c√≥digo
    optSubir.classList.add('disabled');
    optGraf.classList.add('disabled');
    optCalif.classList.add('disabled');

    linkSubir.removeAttribute('href');
    linkGraf.removeAttribute('href');
    // Calificaciones ya est√° deshabilitada por defecto

    // Asistencia s√≠ est√° permitida con code
    linkAsis.href = `./tomarlista.html?${qp({ sid, gid, code })}`;

    try{
      const snap = await getDoc(doc(db,'accesos', code));
      if(!snap.exists()){ alert('C√≥digo inv√°lido.'); location.href = './index.html'; return; }
      const acc = snap.data() || {};
      const allowed = !!(acc.activo && acc.escuelaId === sid && Array.isArray(acc.grupos) && acc.grupos.includes(gid));
      if(!allowed){
        alert('Este c√≥digo no tiene permisos para este grupo.');
        location.href = `./grupos.html?${qp({ sid, code })}`;
        return;
      }
    }catch(e){
      console.error(e);
      alert('Error validando el c√≥digo.');
      location.href = './index.html';
    }
  }

  // INIT
  import { getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  (async function init(){
    await loadSchoolNameOnly();   // ‚Üê solo muestra el nombre de la escuela
    await enforceCodeMode();
  })();
</script>
</body>
</html>