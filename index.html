<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Control de Asistencia ¬∑ Inicio</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#4A90E2">
  <link rel="apple-touch-icon" href="./icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    :root{
      --primary:#4A90E2; --primary-2:#2E5FAA;
      --text:#333; --muted:#6b7280; --card:#fff; --bg:#f5f5f5;
      --danger:#e11d48;
    }
    *{ box-sizing:border-box; margin:0; padding:0; font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif; }
    body{ background:var(--bg); color:var(--text); line-height:1.6; }
    header{
      background:linear-gradient(135deg,var(--primary),var(--primary-2));
      color:#fff; padding:15px 0; text-align:center;
      box-shadow:0 2px 5px rgba(0,0,0,0.1); position:sticky; top:0;
    }
    .container{ max-width:640px; margin:0 auto; padding:22px; }

    .welcome-message{ text-align:center; margin:36px 0 28px; }
    .welcome-icon{ font-size:54px; margin-bottom:14px; color:var(--primary); }

    .card{
      background:var(--card); border-radius:14px; padding:18px;
      box-shadow:0 6px 18px rgba(0,0,0,.05); border:1px solid #e9eef6;
    }

    label{ font-size:14px; color:#111827; font-weight:600; display:block; margin-bottom:8px; }
    .form-grid{
      display:grid; grid-template-columns: 1fr auto; gap:12px; align-items:end;
    }
    @media (max-width: 520px){ .form-grid{ grid-template-columns: 1fr; } }

    input{
      width:100%; padding:12px 14px; border:1px solid #d1d5db; border-radius:10px; font-size:15px;
      transition:border-color .2s, box-shadow .2s, background .2s;
      height:44px; background:#fafafa;
    }
    input:focus{
      outline:none; border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(74,144,226,.25); background:#fff;
    }

    .btn{
      background:linear-gradient(135deg,var(--primary),#3A80D2);
      color:#fff; border:none; border-radius:10px; cursor:pointer;
      font-size:15px; font-weight:600; text-decoration:none;
      transition:filter .2s, transform .05s, box-shadow .2s;
      box-shadow:0 6px 14px rgba(74,144,226,.25);
      padding:0 18px; height:44px; display:inline-flex; align-items:center; justify-content:center;
    }
    .btn:hover{ filter:brightness(1.05); }
    .btn:active{ transform:translateY(1px); }
    .btn[aria-disabled="true"]{ opacity:.6; pointer-events:none; }
    .btn:disabled{ opacity:.7; cursor:not-allowed; box-shadow:none; }

    .btn-secondary{
      background:linear-gradient(135deg,#6c757d,#5a6268);
      box-shadow:0 6px 14px rgba(108,117,125,.22);
      width:100%; margin-top:10px;
    }

    .hint{ color:var(--muted); font-size:13px; margin-top:6px; }
    .status-error{ color:var(--danger); margin-top:8px; font-weight:600; }
    .hidden { display:none; }

    .actions{ margin-top:18px; display:flex; flex-direction:column; gap:10px; }
    .actions .btn{ width:100%; }

    /* Barra superior con bot√≥n instalar */
    .topbar {
      position:sticky; top:0; z-index:20; background:var(--bg);
      padding:8px 22px; display:flex; justify-content:flex-end; gap:8px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Control de Asistencia</h1>
  </header>

  <!-- Bot√≥n Instalar (se muestra cuando el navegador dispare beforeinstallprompt) -->
  <div class="topbar">
    <button id="btnInstall" class="btn" style="display:none">üì≤ Instalar app</button>
  </div>

  <div class="container">
    <!-- Bienvenida -->
    <div class="welcome-message">
      <div class="welcome-icon">üè´</div>
      <h2 id="bienvenida">Bienvenido Maestro</h2>
      <p id="bienvenidaTexto">Ingresa tu c√≥digo para continuar</p>
    </div>

    <!-- Ingreso de c√≥digo -->
    <div class="card" id="codigoCard">
      <label for="codigo">C√≥digo</label>
      <div class="form-grid">
        <input id="codigo" placeholder="Escribe tu c√≥digo aqu√≠" autocomplete="one-time-code" />
        <button id="btnValidar" class="btn">Validar c√≥digo</button>
        <div class="hint">
          ‚Ä¢ Si es <b>c√≥digo de escuela</b> te enviar√° a <b>Grupos</b> y ah√≠ ver√°s <i>solo tus grupos</i>.<br>
          ‚Ä¢ Si es <b>c√≥digo de maestro</b> podr√°s administrar <i>solo tus</i> escuelas.
        </div>
        <div id="errorCodigo" class="status-error hidden">‚ùå C√≥digo inv√°lido</div>
      </div>
    </div>

    <!-- Botones de acci√≥n (solo para maestros) -->
    <div class="actions">
      <a id="goEscuelas" class="btn" href="./escuelas.html" aria-disabled="true">Ir a Escuelas</a>
      <button id="btnSalir" class="btn btn-secondary hidden">Salir</button>
    </div>
  </div>

  <!-- Firebase + Firestore -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, getDoc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBEIeZz3HeU-8EVirVx9JAYnGbBegh1Uh4",
      authDomain: "maestros-7faa6.firebaseapp.com",
      projectId: "maestros-7faa6",
      storageBucket: "maestros-7faa6.firebasestorage.app",
      messagingSenderId: "328284079222",
      appId: "1:328284079222:web:f0ab5c3443469d145d4b57",
      measurementId: "G-YKBQD9EJH3"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // Firestore offline (opcional pero recomendado)
    try {
      await enableIndexedDbPersistence(db);
      console.log('Firestore offline OK');
    } catch (e) {
      console.warn('Firestore offline no habilitado:', e);
    }

    const codigoInput   = document.getElementById("codigo");
    const btnValidar    = document.getElementById("btnValidar");
    const errorCodigo   = document.getElementById("errorCodigo");
    const goBtn         = document.getElementById("goEscuelas");
    const btnSalir      = document.getElementById("btnSalir");
    const codigoCard    = document.getElementById("codigoCard");
    const bienvenida    = document.getElementById("bienvenida");
    const bienvenidaTxt = document.getElementById("bienvenidaTexto");

    const norm = (v)=> (v||"").trim().toUpperCase();

    (function hydrateFromSession(){
      const maestroCode = sessionStorage.getItem('maestroCode');
      const maestroNombre = sessionStorage.getItem('maestroNombre');
      if(maestroCode){
        bienvenida.textContent = `Bienvenido Maestro ${maestroNombre || ''}`.trim();
        bienvenidaTxt.textContent = "Puedes continuar a tus escuelas";
        goBtn.setAttribute("aria-disabled","false");
        btnSalir.classList.remove("hidden");
        codigoCard.classList.add("hidden");
      }
      if(!maestroCode) codigoInput?.focus();
    })();

    async function validarCodigo(){
      const codigo = norm(codigoInput.value);
      errorCodigo.classList.add("hidden");
      goBtn.setAttribute("aria-disabled","true");
      btnSalir.classList.add("hidden");

      if(!codigo){
        errorCodigo.textContent = "‚ö† Ingresa un c√≥digo";
        errorCodigo.classList.remove("hidden");
        return;
      }

      const originalText = btnValidar.textContent;
      btnValidar.disabled = true;
      btnValidar.textContent = "Validando‚Ä¶";

      try{
        // 1) C√≥digo de escuela (colecci√≥n 'accesos')
        const accSnap = await getDoc(doc(db,"accesos", codigo));
        if (accSnap.exists()){
          const acc = accSnap.data() || {};
          if (!acc.activo){
            errorCodigo.textContent = "‚ùå Este c√≥digo est√° inactivo.";
            errorCodigo.classList.remove("hidden");
            btnValidar.disabled = false;
            btnValidar.textContent = originalText;
            return;
          }
          if (acc.escuelaId && Array.isArray(acc.grupos) && acc.grupos.length){
            sessionStorage.removeItem('maestroCode');
            sessionStorage.removeItem('maestroNombre');
            sessionStorage.setItem('accesoCode', codigo);
            window.location.href = `./grupos.html?sid=${encodeURIComponent(acc.escuelaId)}&code=${encodeURIComponent(codigo)}`;
            return;
          }
        }

        // 2) C√≥digo de maestro
        const maestroSnap = await getDoc(doc(db, "maestros", codigo));
        if (maestroSnap.exists()){
          const maestro = maestroSnap.data() || {};
          const nombre  = maestro.nombre || "Maestro";
          sessionStorage.setItem('maestroCode', codigo);
          sessionStorage.setItem('maestroNombre', nombre);
          sessionStorage.removeItem('accesoCode');

          bienvenida.textContent = `Bienvenido Maestro ${nombre}`;
          bienvenidaTxt.textContent = "Puedes continuar a tus escuelas";
          goBtn.setAttribute("aria-disabled","false");
          btnSalir.classList.remove("hidden");
          codigoCard.classList.add("hidden");

          btnValidar.disabled = false;
          btnValidar.textContent = originalText;
          return;
        }

        // 3) Ninguno
        errorCodigo.textContent = "‚ùå C√≥digo inv√°lido";
        errorCodigo.classList.remove("hidden");
      }catch(e){
        console.error(e);
        errorCodigo.textContent = "‚ö† Error al validar c√≥digo";
        errorCodigo.classList.remove("hidden");
      }finally{
        btnValidar.disabled = false;
        btnValidar.textContent = originalText;
      }
    }

    function salir(){
      bienvenida.textContent = "Bienvenido Maestro";
      bienvenidaTxt.textContent = "Ingresa tu c√≥digo para continuar";
      goBtn.setAttribute("aria-disabled","true");
      btnSalir.classList.add("hidden");
      codigoCard.classList.remove("hidden");
      codigoInput.value = "";
      codigoInput.focus();
      sessionStorage.removeItem('accesoCode');
      sessionStorage.removeItem('maestroCode');
      sessionStorage.removeItem('maestroNombre');
    }

    btnValidar.addEventListener("click", validarCodigo);
    codigoInput.addEventListener("keydown", e => { if(e.key==="Enter") validarCodigo(); });
    btnSalir.addEventListener("click", salir);

    // === Bot√≥n "Instalar app" (A2HS) ===
    let deferredPrompt = null;
    const btnInstall = document.getElementById('btnInstall');

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();        // Evita el mini-infobar
      deferredPrompt = e;        // Guarda el evento para usarlo luego
      if (btnInstall) btnInstall.style.display = 'inline-flex';
    });

    btnInstall?.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();   // Lanza el prompt nativo
      const choice = await deferredPrompt.userChoice;
      console.log('A2HS:', choice.outcome); // accepted / dismissed
      deferredPrompt = null;
      btnInstall.style.display = 'none';
    });

    window.addEventListener('appinstalled', () => {
      console.log('App instalada');
      if (btnInstall) btnInstall.style.display = 'none';
    });

    // === Registro del Service Worker ===
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js', { scope: './' })
          .then(reg => console.log('SW registrado:', reg.scope))
          .catch(err => console.warn('SW error:', err));
      });
    }
  </script>
</body>
</html>
