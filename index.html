<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Control de Asistencia ¬∑ Inicio</title>
  <style>
    *{ box-sizing:border-box; margin:0; padding:0; font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif; }
    body{ background:#f5f5f5; color:#333; line-height:1.6; }
    header{ background:linear-gradient(135deg,#4A90E2,#2E5FAA); color:#fff; padding:15px 0; text-align:center; box-shadow:0 2px 5px rgba(0,0,0,0.1); position:sticky; top:0; }
    .container{ max-width:600px; margin:0 auto; padding:20px; }
    .welcome-message{ text-align:center; margin:40px 0; }
    .welcome-icon{ font-size:60px; margin-bottom:20px; color:#4A90E2; }
    .card{ background:#fff; border-radius:10px; padding:15px; margin-bottom:20px; box-shadow:0 3px 10px rgba(0,0,0,0.08); text-align:center; }
    .btn{ display:block; text-align:center; background:linear-gradient(135deg,#4A90E2,#3A80D2); color:#fff; border:none; padding:12px 20px; border-radius:8px; cursor:pointer; font-size:16px; text-decoration:none; transition:.2s; margin-bottom:10px; }
    .btn[aria-disabled="true"]{ opacity:.6; pointer-events:none; }
    .btn:hover{ filter:brightness(1.05); }
    .btn-secondary { background:linear-gradient(135deg, #6c757d, #5a6268); }
    .status-error { color: red; margin-top:10px; }
    .hidden { display: none; }
    input{ width:100%; padding:10px; border:1px solid #ccc; border-radius:8px; margin-top:8px; font-size:15px }
    input:focus{ outline:none; border-color:#4A90E2; box-shadow:0 0 0 2px rgba(74,144,226,.3) }
    .hint{ color:#6b7280; font-size:13px; margin-top:6px }
  </style>
</head>
<body>
  <header>
    <h1>Control de Asistencia</h1>
  </header>

  <div class="container">
    <!-- Bienvenida -->
    <div class="welcome-message">
      <div class="welcome-icon">üè´</div>
      <h2 id="bienvenida">Bienvenido Maestro</h2>
      <p id="bienvenidaTexto">Ingresa tu c√≥digo para continuar</p>
    </div>

    <!-- Ingreso de c√≥digo -->
    <div class="card" id="codigoCard">
      <label for="codigo">C√≥digo</label>
      <input id="codigo" placeholder="Escribe tu c√≥digo aqu√≠"/>
      <button id="btnValidar" class="btn">Validar c√≥digo</button>
      <div class="hint">
        ‚Ä¢ Si es <b>c√≥digo de escuela</b> te enviar√° a <b>Grupos</b> y ah√≠ ver√°s <i>solo tus grupos</i>.<br>
        ‚Ä¢ Si es <b>c√≥digo de maestro</b> podr√°s administrar <i>solo tus</i> escuelas.
      </div>
      <div id="errorCodigo" class="status-error hidden">‚ùå C√≥digo inv√°lido</div>
    </div>

    <!-- Botones de acci√≥n (solo para maestros) -->
    <a id="goEscuelas" class="btn" href="./escuelas.html" aria-disabled="true">Ir a Escuelas</a>
    <button id="btnSalir" class="btn btn-secondary hidden">Salir</button>
  </div>

  <!-- Firebase + Firestore -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBEIeZz3HeU-8EVirVx9JAYnGbBegh1Uh4",
      authDomain: "maestros-7faa6.firebaseapp.com",
      projectId: "maestros-7faa6",
      storageBucket: "maestros-7faa6.firebasestorage.app",
      messagingSenderId: "328284079222",
      appId: "1:328284079222:web:f0ab5c3443469d145d4b57",
      measurementId: "G-YKBQD9EJH3"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    const codigoInput   = document.getElementById("codigo");
    const btnValidar    = document.getElementById("btnValidar");
    const errorCodigo   = document.getElementById("errorCodigo");
    const goBtn         = document.getElementById("goEscuelas");
    const btnSalir      = document.getElementById("btnSalir");
    const codigoCard    = document.getElementById("codigoCard");
    const bienvenida    = document.getElementById("bienvenida");
    const bienvenidaTxt = document.getElementById("bienvenidaTexto");

    const norm = (v)=> (v||"").trim().toUpperCase();

    (function hydrateFromSession(){
      const maestroCode = sessionStorage.getItem('maestroCode');
      const maestroNombre = sessionStorage.getItem('maestroNombre');
      if(maestroCode){
        bienvenida.textContent = `Bienvenido Maestro ${maestroNombre || ''}`.trim();
        bienvenidaTxt.textContent = "Puedes continuar a tus escuelas";
        goBtn.setAttribute("aria-disabled","false");
        btnSalir.classList.remove("hidden");
        codigoCard.classList.add("hidden");
      }
    })();

    async function validarCodigo(){
      const codigo = norm(codigoInput.value);
      errorCodigo.classList.add("hidden");
      goBtn.setAttribute("aria-disabled","true");
      btnSalir.classList.add("hidden");

      if(!codigo){
        errorCodigo.textContent = "‚ö† Ingresa un c√≥digo";
        errorCodigo.classList.remove("hidden");
        return;
      }

      btnValidar.disabled = true;

      try{
        // 1) ¬øC√≥digo de escuela? (accesos)
        const accSnap = await getDoc(doc(db,"accesos", codigo));
        if (accSnap.exists()){
          const acc = accSnap.data() || {};
          if (!acc.activo){
            errorCodigo.textContent = "‚ùå Este c√≥digo est√° inactivo.";
            errorCodigo.classList.remove("hidden");
            btnValidar.disabled = false;
            return;
          }
          if (acc.escuelaId && Array.isArray(acc.grupos) && acc.grupos.length){
            // Limpia sesi√≥n de maestro y guarda el code de acceso
            sessionStorage.removeItem('maestroCode');
            sessionStorage.removeItem('maestroNombre');
            sessionStorage.setItem('accesoCode', codigo);

            // **NUEVO FLUJO**: SIEMPRE manda a grupos (aunque sea 1 grupo)
            window.location.href = `./grupos.html?sid=${encodeURIComponent(acc.escuelaId)}&code=${encodeURIComponent(codigo)}`;
            return;
          }
        }

        // 2) ¬øC√≥digo de maestro?
        const maestroSnap = await getDoc(doc(db, "maestros", codigo));
        if (maestroSnap.exists()){
          const maestro = maestroSnap.data() || {};
          const nombre  = maestro.nombre || "Maestro";

          sessionStorage.setItem('maestroCode', codigo);
          sessionStorage.setItem('maestroNombre', nombre);
          sessionStorage.removeItem('accesoCode');

          bienvenida.textContent = `Bienvenido Maestro ${nombre}`;
          bienvenidaTxt.textContent = "Puedes continuar a tus escuelas";
          goBtn.setAttribute("aria-disabled","false");
          btnSalir.classList.remove("hidden");
          codigoCard.classList.add("hidden");
          btnValidar.disabled = false;
          return;
        }

        // 3) Ninguno
        errorCodigo.textContent = "‚ùå C√≥digo inv√°lido";
        errorCodigo.classList.remove("hidden");
      }catch(e){
        console.error(e);
        errorCodigo.textContent = "‚ö† Error al validar c√≥digo";
        errorCodigo.classList.remove("hidden");
      }finally{
        btnValidar.disabled = false;
      }
    }

    function salir(){
      bienvenida.textContent = "Bienvenido Maestro";
      bienvenidaTxt.textContent = "Ingresa tu c√≥digo para continuar";
      goBtn.setAttribute("aria-disabled","true");
      btnSalir.classList.add("hidden");
      codigoCard.classList.remove("hidden");
      codigoInput.value = "";

      sessionStorage.removeItem('accesoCode');
      sessionStorage.removeItem('maestroCode');
      sessionStorage.removeItem('maestroNombre');
    }

    btnValidar.addEventListener("click", validarCodigo);
    codigoInput.addEventListener("keydown", e => { if(e.key==="Enter") validarCodigo(); });
    btnSalir.addEventListener("click", salir);
  </script>
</body>
</html>
