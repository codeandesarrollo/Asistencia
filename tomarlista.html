<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Tomar asistencia</title>
<style>
  :root{
    --primary:#4A90E2; --success:#28a745; --warning:#ffc107; --danger:#dc3545;
    --card:#fff; --txt:#2b2f36; --muted:#64748b; --radius:14px;
  }
  *{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,Segoe UI,Roboto,sans-serif}
  html,body{height:100%}
  body{background:#f5f6fb;color:var(--txt); -webkit-text-size-adjust:100%}
  header{
    background:linear-gradient(135deg,var(--primary),#2E5FAA);
    color:#fff; padding:18px 0; text-align:center
  }
  header h1{font-size:clamp(20px,2.6vw,28px); font-weight:800; letter-spacing:.2px}
  #ctx{opacity:.95; font-size:clamp(12px,1.8vw,14px); margin-top:6px}

  .container{max-width:960px;margin:0 auto;padding:clamp(14px,2vw,24px)}
  .card{
    background:var(--card); border-radius:var(--radius);
    padding:clamp(14px,2.4vw,22px);
    border:1px solid #e6ebf3; box-shadow:0 6px 18px rgba(0,0,0,.05);
    margin-top:12px
  }

  .row{display:flex; gap:12px; flex-wrap:wrap; margin-bottom:16px; align-items:flex-end}
  .form-control{
    padding:10px;border:1px solid #ddd;border-radius:8px;font-size:16px;min-height:44px
  }
  input[type="date"]{width:100%}
  .legend{display:flex;gap:10px;align-items:center;font-size:13px;color:#445;flex-wrap:wrap;margin-top:6px}
  .dot{width:10px;height:10px;border-radius:50%;display:inline-block;vertical-align:middle}
  .p{background:var(--success)} .t{background:var(--warning)} .a{background:var(--danger)}

  /* --- FILA DE ALUMNO: mobile-first (2 renglones) --- */
  .attendance-row{
    display:grid;
    grid-template-columns: 2.4ch 1fr auto;
    grid-template-areas:
      "num name del"
      "radios radios radios";
    align-items:center;
    padding:12px;
    border-bottom:1px solid #eee;
    gap:10px;
  }
  .num{grid-area:num; text-align:right; color:#64748b; font-weight:700;
       font-variant-numeric: tabular-nums; opacity:.9}
  .alumno-name{grid-area:name; min-width:0; overflow-wrap:anywhere}
  .icon-btn{grid-area:del; border:1px solid #e5e7eb; background:#fff; border-radius:10px;
            padding:8px 10px; cursor:pointer; min-height:40px}
  .icon-btn:hover{background:#f8fafc}
  .icon-btn.danger{border-color:#fca5a5;color:#b91c1c}

  .radio-group{
    grid-area:radios;
    display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:8px; width:100%
  }
  .radio-group input{display:none}
  .radio-group label{
    display:flex; align-items:center; justify-content:center;
    padding:10px 12px; border:1px solid #cfd3da; border-radius:10px;
    cursor:pointer; font-size:16px; min-height:44px; user-select:none
  }
  .radio-group input:checked+label{background:var(--primary); color:#fff; border-color:var(--primary); box-shadow:0 2px 6px rgba(14,111,255,.18)}

  /* --- Botones --- */
  .btn{
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    background:linear-gradient(135deg,var(--primary),#2E5FAA);
    color:#fff; text-decoration:none; padding:10px 16px; border-radius:10px;
    font-weight:700; border:none; cursor:pointer; min-height:44px
  }
  .btn-outline{background:transparent;color:var(--primary)!important;border:1px solid var(--primary)}
  .msg{margin-top:12px;padding:10px;border-radius:8px;font-size:14px}
  .ok{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
  .err{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
  .login-form {max-width: 520px; margin: 20px auto; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);}
  .login-form input {width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; font-size:16px}

  .add-student{display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:16px}
  .add-student input{flex:1 1 260px}

  /* Compactar SOLO el input de "Agregar alumno" */
  .add-student .form-control{
    height:36px;
    min-height:36px;
    padding:6px 10px;
    font-size:14px;
    line-height:1.2;
    border-radius:8px;
  }
  .add-student .btn{
    min-height:40px;
    padding:8px 12px;
    font-size:15px;
  }

  .actions{display:flex; gap:8px; flex-wrap:wrap}

  /* --- Responsivo --- */
  @media (min-width:700px){
    .attendance-row{
      grid-template-columns: 36px 1fr auto auto;
      grid-template-areas: "num name radios del";
      align-items:center
    }
    .radio-group{display:flex; gap:8px; width:auto}
    .radio-group label{min-width:48px}
  }

  @media (max-width:640px){
    .actions{flex-direction:column}
    .actions .btn,
    .add-student .btn{width:100%}
    .add-student{flex-direction:column; align-items:stretch}
    .row > div{flex:1 1 100%}
    .btn-outline.btn{order:3}
  }

  @media (max-width:480px){
    .add-student .form-control{
      height:34px;
      min-height:34px;
      padding:6px 10px;
      font-size:13.5px;
    }
  }

  @media (prefers-reduced-motion:no-preference){
    .btn, .radio-group label{transition:transform .06s ease, box-shadow .12s ease}
    .btn:active, .radio-group label:active{transform:translateY(1px)}
  }

  /* ====== OVERRIDE FINAL (gana a Bootstrap, etc.) ====== */
  .add-student input.form-control[type="text"]{
    box-sizing: border-box !important;
    display: block !important;
    height: 32px !important;
    min-height: 32px !important;
    padding: 4px 10px !important;
    font-size: 14px !important;
    line-height: 20px !important;
    border-radius: 8px !important;
    -webkit-appearance: none !important;
    appearance: none !important;
  }
  @media (max-width:480px){
    .add-student input.form-control[type="text"]{
      height: 30px !important;
      min-height: 30px !important;
      padding: 4px 8px !important;
      font-size: 13.5px !important;
      line-height: 18px !important;
    }
  }
  .add-student input.form-control[type="text"]:focus{
    outline: none !important;
    box-shadow: 0 0 0 3px rgba(74,144,226,.25) !important;
    border-color: #7aaef0 !important;
  }
  /* Fuerza compacto SOLO en Agregar alumno, sea input o textarea */
.add-student #newStudentName{
  box-sizing: border-box !important;
  display: block !important;
  height: 32px !important;
  min-height: 32px !important;
  max-height: 32px !important;
  padding: 4px 10px !important;
  font-size: 14px !important;
  line-height: 20px !important;
  border-radius: 8px !important;
  -webkit-appearance: none !important;
  appearance: none !important;
  resize: none !important;          /* si fuera textarea */
  overflow: hidden !important;       /* si fuera textarea */
}

@media (max-width:480px){
  .add-student #newStudentName{
    height: 30px !important;
    min-height: 30px !important;
    max-height: 30px !important;
    padding: 4px 8px !important;
    font-size: 13.5px !important;
    line-height: 18px !important;
  }
}

</style>



</head>
<body>
<header>
  <h1>Tomar asistencia</h1>
  <p id="ctx"></p>
</header>

<div class="container">
  <!-- Acceso por c√≥digo -->
  <div id="codeAccess" class="card login-form" style="display:none;">
    <h2 style="font-size:clamp(18px,2.2vw,22px);margin-bottom:10px">Acceso por c√≥digo</h2>
    <input id="accessCode" class="form-control" placeholder="Ingresa el c√≥digo de acceso">
    <button id="btnAccess" class="btn" style="width:100%">Acceder</button>
    <div id="codeMsg" class="msg" style="display:none; margin-top:12px"></div>
  </div>

  <!-- Interfaz principal -->
  <div id="attendanceInterface" class="card" style="display:none;">
    <div class="row">
      <div style="flex:1 1 260px">
        <label for="fechaAsis" style="display:block; margin-bottom:6px; font-weight:600; color:#374151">Fecha</label>
        <input id="fechaAsis" type="date" class="form-control"/>
        <div class="legend">
          <span><span class="dot p"></span> A = Asistencia</span>
          <span><span class="dot t"></span> R = Retardo</span>
          <span><span class="dot a"></span> F = Falta</span>
        </div>
      </div>
      <div style="margin-left:auto">
        <a id="btnBack" class="btn-outline btn" href="opcionesgrupo.html">‚Üê Regresar</a>
      </div>
    </div>

    <!-- Acciones r√°pidas -->
    <div class="actions" style="margin-top:0">
      <button id="markAllA" class="btn">‚úì Todos A (asistencia)</button>
      <button id="markAllF" class="btn btn-outline">‚úó Todos F (falta)</button>
      <button id="saveAsis" class="btn" style="margin-left:auto">üíæ Guardar asistencia</button>
    </div>

    <!-- Agregar alumno manual -->
    <div class="add-student">
      <input id="newStudentName" type="text" class="form-control" placeholder="Nombre del alumno (p. ej. Juan P√©rez)"/>
      <button id="addStudentBtn" class="btn">‚ûï Agregar alumno</button>
    </div>

    <!-- Lista -->
    <div id="asisList" style="margin-top:8px"><p>Ingresa un c√≥digo de acceso para comenzar.</p></div>

    <div id="msg" class="msg" style="display:none"></div>
  </div>
</div>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore, collection, collectionGroup, getDocs, getDoc, setDoc, doc, serverTimestamp, addDoc, deleteDoc
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // ===== Firebase =====
  const app = initializeApp({
    apiKey: "AIzaSyBEIeZz3HeU-8EVirVx9JAYnGbBegh1Uh4",
    authDomain: "maestros-7faa6.firebaseapp.com",
    projectId: "maestros-7faa6",
    storageBucket: "maestros-7faa6.firebasestorage.app",
    messagingSenderId: "328284079222",
    appId: "1:328284079222:web:f0ab5c3443469d145d4b57",
    measurementId: "G-YKBQD9EJH3"
  });
  const db  = getFirestore(app);

  // ===== UI =====
  const codeAccessDiv = document.getElementById('codeAccess');
  const attendanceInterface = document.getElementById('attendanceInterface');
  const accessCodeInput = document.getElementById('accessCode');
  const btnAccess = document.getElementById('btnAccess');
  const codeMsg = document.getElementById('codeMsg');
  const fechaAsis = document.getElementById('fechaAsis');
  const asisList = document.getElementById('asisList');
  const msg = document.getElementById('msg');
  const markAllA = document.getElementById('markAllA');
  const markAllF = document.getElementById('markAllF');
  const saveAsis = document.getElementById('saveAsis');
  const btnBack = document.getElementById('btnBack');
  const ctx = document.getElementById('ctx');
  const newStudentName = document.getElementById('newStudentName');
  const addStudentBtn  = document.getElementById('addStudentBtn');

  // ===== Estado =====
  let alumnos = [];
  let asistencia = {};
  let currentSid = null;
  let currentGid = null;
  let allowedGroups = [];
  let currentCode = null; // << mantiene el ?code activo
  let m = null; // maestro resuelto
  // Nombres legibles
  let currentSchoolName = null;
  let currentGroupName  = null;

  // ===== Helpers =====
  const coll = new Intl.Collator('es', { sensitivity: 'base', ignorePunctuation: true, numeric: true });

  const p = new URLSearchParams(location.search);
  const sidParam = p.get('sid');
  const gidParam = p.get('gid');
  currentCode = p.get('code') || null; // << toma code si ven√≠a en la URL

  function todayStr(){ return new Date().toISOString().slice(0,10); }
  fechaAsis.value = todayStr();

  function showMsg(el, text, kind='ok'){
    el.style.display='block';
    el.className = `msg ${kind==='ok'?'ok':'err'}`;
    el.textContent = text;
    setTimeout(()=>el.style.display='none', 3200);
  }

  function normalizeName(s=''){
    return s.normalize('NFD').replace(/\p{Diacritic}/gu, '').toLowerCase().trim();
  }

  async function resolveMaestroBySchoolId(sid){
    const cg = await getDocs(collectionGroup(db, 'escuelas'));
    const found = cg.docs.find(d => d.id === sid);
    if (!found) return null;
    return found.ref.parent.parent?.id || null; // maestros/{m}
  }

  // === Helpers de nombres y encabezado ===
  async function fetchSchoolName(sid){
    if (!sid) return sid;
    const sref  = doc(db, 'maestros', m, 'escuelas', sid);
    const ssnap = await getDoc(sref);
    currentSchoolName = ssnap.exists()
      ? (ssnap.data().name || ssnap.data().nombre || sid)
      : sid;
    return currentSchoolName;
  }

  async function fetchGroupName(sid, gid){
    if (!sid || !gid) return gid;
    const gref  = doc(db, 'maestros', m, 'escuelas', sid, 'grupos', gid);
    const gsnap = await getDoc(gref);
    currentGroupName = gsnap.exists()
      ? (gsnap.data().name || gsnap.data().nombre || gid)
      : gid;
    return currentGroupName;
  }

  function updateCtx(extra=''){
    const s = currentSchoolName || currentSid || '';
    const g = currentGroupName  || currentGid || '';
    ctx.textContent = (s && g) ? `Escuela: ${s} ¬∑ Grupo: ${g}${extra}` :
                      s ? `Escuela: ${s}${extra}` :
                      extra ? extra.replace(/^ ¬∑ /,'') : '';
  }

  // ==== Flujo de inicio ====
  if (sidParam && gidParam){
    currentSid = sidParam;
    currentGid = gidParam;

    btnBack.href = currentCode
      ? `opcionesgrupo.html?sid=${encodeURIComponent(currentSid)}&gid=${encodeURIComponent(currentGid)}&code=${encodeURIComponent(currentCode)}`
      : `opcionesgrupo.html?sid=${encodeURIComponent(currentSid)}&gid=${encodeURIComponent(currentGid)}`;

    m = await resolveMaestroBySchoolId(currentSid);
    if(!m){
      showMsg(msg, 'No se encontr√≥ la escuela bajo ning√∫n maestro.', 'err');
    } else {
      await fetchSchoolName(currentSid);
      await fetchGroupName(currentSid, currentGid);
      updateCtx();
      codeAccessDiv.style.display='none';
      attendanceInterface.style.display='block';
      await initializeAttendance();
    }
  } else {
    codeAccessDiv.style.display='block';
    attendanceInterface.style.display='none';
    ctx.textContent = 'Acceso por c√≥digo';
    btnBack.href = './index.html';
  }

  // === Acceso por c√≥digo ===
  btnAccess.addEventListener('click', async () => {
    const code = accessCodeInput.value.trim();
    if(!code){ showMsg(codeMsg, 'Ingresa un c√≥digo de acceso', 'err'); return; }

    try {
      const codeRef = doc(db, 'accesos', code);
      const codeSnap = await getDoc(codeRef);
      if(!codeSnap.exists()){ showMsg(codeMsg, 'C√≥digo inv√°lido', 'err'); return; }

      const codeData = codeSnap.data();
      if(!codeData.activo){ showMsg(codeMsg, 'Este c√≥digo ya no est√° activo', 'err'); return; }

      currentCode = code;
      currentSid = codeData.escuelaId;
      allowedGroups = Array.isArray(codeData.grupos) ? codeData.grupos : [];

      if(!currentSid || !allowedGroups.length){ showMsg(codeMsg, 'El c√≥digo no tiene escuela/grupos asignados', 'err'); return; }

      m = await resolveMaestroBySchoolId(currentSid);
      if(!m){ showMsg(codeMsg, 'No se encontr√≥ la escuela bajo ning√∫n maestro.', 'err'); return; }

      // NOMBRE DE ESCUELA PARA EL HEADER
      await fetchSchoolName(currentSid);
      updateCtx();

      btnBack.href = `grupos.html?sid=${encodeURIComponent(currentSid)}&code=${encodeURIComponent(currentCode)}`;

      if (allowedGroups.length === 1){
        currentGid = allowedGroups[0];
        await loadGroupInfo(currentSid, currentGid);
      } else {
        await showGroupSelector(currentSid, allowedGroups);
      }

      codeAccessDiv.style.display = 'none';
      attendanceInterface.style.display = 'block';
    } catch (e){
      console.error('Error verificando c√≥digo:', e);
      showMsg(codeMsg, 'Error al verificar el c√≥digo', 'err');
    }
  });

  // Selector de grupo (si hay varios)
  async function showGroupSelector(schoolId, groupIds){
    const groupsInfo = [];
    for (const gid of groupIds){
      const gref = doc(db, 'maestros', m, 'escuelas', schoolId, 'grupos', gid);
      const gsnap = await getDoc(gref);
      groupsInfo.push({ id: gid, name: gsnap.exists() ? (gsnap.data().name || gid) : gid });
    }
    asisList.innerHTML = `
      <h3 style="margin:8px 0 2px;font-size:18px">Selecciona un grupo:</h3>
      <div style="display:flex; flex-direction:column; gap:10px; margin-top:10px;">
        ${groupsInfo.map(g=>`
          <button class="btn" data-g="${g.id}">${g.name}</button>
        `).join('')}
      </div>
    `;
    asisList.querySelectorAll('button[data-g]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        currentGid = btn.getAttribute('data-g');
        await loadGroupInfo(currentSid, currentGid);
      });
    });
    updateCtx(' ¬∑ Selecciona grupo');
  }

  // Cargar nombre y preparar interfaz para un grupo
  async function loadGroupInfo(schoolId, groupId){
    try{
      if (!currentSchoolName) await fetchSchoolName(schoolId);
      await fetchGroupName(schoolId, groupId);
      updateCtx();

      btnBack.href = currentCode
        ? `opcionesgrupo.html?sid=${encodeURIComponent(schoolId)}&gid=${encodeURIComponent(groupId)}&code=${encodeURIComponent(currentCode)}`
        : `opcionesgrupo.html?sid=${encodeURIComponent(schoolId)}&gid=${encodeURIComponent(groupId)}`;

      await initializeAttendance();
    }catch(e){
      console.error('Error cargando informaci√≥n del grupo:', e);
      showMsg(msg, 'Error al cargar informaci√≥n del grupo', 'err');
    }
  }

  async function initializeAttendance(){
    await loadAlumnos();
    await loadAsistenciaForDate(fechaAsis.value || todayStr());
  }

  // === Cargar alumnos (ordenados A‚ÄìZ) ===
  async function loadAlumnos(){
    alumnos = [];
    try{
      const snap = await getDocs(collection(db, 'maestros', m, 'escuelas', currentSid, 'grupos', currentGid, 'alumnos'));
      snap.forEach(d=> alumnos.push({ id: d.id, name: d.data().name || '' }));
      alumnos.sort((a, b) => coll.compare(a.name || '', b.name || ''));
      renderAsis();
    }catch(e){
      console.error('Error cargando alumnos:', e);
      showMsg(msg, 'Error al cargar los alumnos', 'err');
    }
  }

  // === Render con numeraci√≥n e √≠cono eliminar ===
  function renderAsis(){
    if(!alumnos.length){
      asisList.innerHTML = '<p>No hay alumnos en este grupo.</p>';
      return;
    }
    asisList.innerHTML = '';
    alumnos.forEach((a, idx)=>{
      const row = document.createElement('div');
      row.className = 'attendance-row';
      row.innerHTML = `
        <div class="num">${idx + 1}</div>
        <div class="alumno-name">${a.name}</div>
        <div class="radio-group">
          <input type="radio" name="r-${a.id}" id="rA-${a.id}" ${asistencia[a.id]==='A'?'checked':''}>
          <label for="rA-${a.id}" title="Asistencia">A</label>
          <input type="radio" name="r-${a.id}" id="rR-${a.id}" ${asistencia[a.id]==='R'?'checked':''}>
          <label for="rR-${a.id}" title="Retardo">R</label>
          <input type="radio" name="r-${a.id}" id="rF-${a.id}" ${asistencia[a.id]==='F'?'checked':''}>
          <label for="rF-${a.id}" title="Falta">F</label>
        </div>
        <button class="icon-btn danger" data-del="${a.id}" title="Eliminar alumno">üóëÔ∏è</button>
      `;
      asisList.appendChild(row);

      row.querySelector(`#rA-${a.id}`).addEventListener('change',()=>asistencia[a.id]='A');
      row.querySelector(`#rR-${a.id}`).addEventListener('change',()=>asistencia[a.id]='R');
      row.querySelector(`#rF-${a.id}`).addEventListener('change',()=>asistencia[a.id]='F');
    });
  }

  async function loadAsistenciaForDate(dateId){
    asistencia = {};
    alumnos.forEach(a=> asistencia[a.id] = 'A');
    try{
      const ref = doc(db, 'maestros', m, 'escuelas', currentSid, 'grupos', currentGid, 'asistencias', dateId);
      const snap = await getDoc(ref);
      if(snap.exists()){
        const regs = snap.data()?.registros || {};
        Object.entries(regs).forEach(([aid, st])=>{
          if(aid in asistencia){
            const v = String(st||'A').toUpperCase();
            asistencia[aid] = (v==='A'||v==='R'||v==='F') ? v : 'A';
          }
        });
        renderAsis();
        showMsg(msg, `Asistencia del ${dateId} cargada.`, 'ok');
      }else{
        renderAsis();
        showMsg(msg, `Sin registro previo para ${dateId}.`, 'ok');
      }
    }catch(e){
      console.error(e);
      renderAsis();
      showMsg(msg, 'No se pudo cargar la asistencia guardada.', 'err');
    }
  }

  // === Agregar alumno manual ===
  addStudentBtn.addEventListener('click', async ()=>{
    const raw = newStudentName.value.trim();
    if(!raw){ showMsg(msg, 'Escribe el nombre del alumno.','err'); return; }
    if(!currentSid || !currentGid || !m){ showMsg(msg, 'Primero selecciona un grupo.','err'); return; }

    const norm = normalizeName(raw);
    const exists = alumnos.some(a => normalizeName(a.name) === norm);
    if(exists){ showMsg(msg, 'Ese alumno ya existe en el grupo.','err'); return; }

    try{
      const colRef = collection(db, 'maestros', m, 'escuelas', currentSid, 'grupos', currentGid, 'alumnos');
      const created = await addDoc(colRef, {
        name: raw,
        createdAt: serverTimestamp()
      });

      alumnos.push({ id: created.id, name: raw });
      alumnos.sort((a, b) => coll.compare(a.name || '', b.name || ''));
      renderAsis();

      asistencia[created.id] = 'A';
      newStudentName.value = '';
      showMsg(msg, 'Alumno agregado correctamente.','ok');
    }catch(e){
      console.error('Error agregando alumno:', e);
      showMsg(msg, 'No se pudo agregar el alumno.','err');
    }
  });

  // === Acciones r√°pidas ===
  markAllA.addEventListener('click', ()=>{ alumnos.forEach(a=>asistencia[a.id]='A'); renderAsis(); });
  markAllF.addEventListener('click', ()=>{ alumnos.forEach(a=>asistencia[a.id]='F'); renderAsis(); });

  fechaAsis.addEventListener('change', ()=> loadAsistenciaForDate(fechaAsis.value || todayStr()));

  saveAsis.addEventListener('click', async ()=>{
    if(!alumnos.length){ showMsg(msg, 'No hay alumnos para guardar.','err'); return; }
    const dateId = fechaAsis.value || todayStr();
    const registros = {};
    alumnos.forEach(a=> registros[a.id] = asistencia[a.id] || 'A');
    try{
      await setDoc(
        doc(db, 'maestros', m, 'escuelas', currentSid, 'grupos', currentGid, 'asistencias', dateId),
        { date: dateId, registros, updatedAt: serverTimestamp() },
        { merge: true }
      );
      showMsg(msg, 'Asistencia del d√≠a guardada correctamente ‚úî');
    }catch(e){
      console.error(e);
      showMsg(msg, 'Error al guardar asistencia','err');
    }
  });

  // === Eliminar alumno (delegaci√≥n en la lista) ===
  asisList.addEventListener('click', async (ev) => {
    const btn = ev.target.closest('[data-del]');
    if(!btn) return;

    const id = btn.getAttribute('data-del');
    const alumno = alumnos.find(x => x.id === id);
    const nombre = alumno?.name || 'este alumno';

    if(!currentSid || !currentGid || !m){
      showMsg(msg, 'Primero selecciona un grupo.','err');
      return;
    }

    const ok = confirm(`¬øEliminar definitivamente a "${nombre}"?`);
    if(!ok) return;

    try{
      await deleteDoc(doc(db, 'maestros', m, 'escuelas', currentSid, 'grupos', currentGid, 'alumnos', id));

      alumnos = alumnos.filter(x => x.id !== id);
      delete asistencia[id];
      renderAsis(); // ‚Üê reenumera autom√°ticamente

      showMsg(msg, 'Alumno eliminado.','ok');
    }catch(e){
      console.error('Error eliminando alumno:', e);
      showMsg(msg, 'No se pudo eliminar el alumno.','err');
    }
  });

  // UX: Enter en el input de c√≥digo
  accessCodeInput?.addEventListener('keyup', e=>{ if(e.key==='Enter') btnAccess.click(); });

  // UX: Enter en el input de nuevo alumno
  newStudentName?.addEventListener('keyup', e=>{ if(e.key==='Enter') addStudentBtn.click(); });
</script>
</body>
</html>
